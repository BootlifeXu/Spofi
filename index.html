<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spofi</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Courier New', monospace;
      }

      body {
        background-color: #f0f0f0;
        color: #333;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto auto;
        gap: 20px;
      }

      .search-bar {
        grid-column: 1 / 2;
        grid-row: 1 / 2;
        display: flex;
        border: 2px solid #333;
        border-radius: 4px;
        overflow: hidden;
      }

      #search-input {
        flex-grow: 1;
        padding: 10px;
        border: none;
        font-size: 16px;
        background-color: #fff;
      }

      #search-button {
        width: 40px;
        background-color: #333;
        color: #f0f0f0;
        border: none;
        cursor: pointer;
      }

      .music-player {
        grid-column: 1 / 3;
        grid-row: 2 / 3;
        border: 2px solid #333;
        border-radius: 4px;
        padding: 15px;
        background-color: #fff;
        display: flex;
        align-items: center;
      }

      .song-info {
        flex-grow: 1;
      }

      .song-title {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .song-artist {
        font-size: 14px;
      }

      .search-results,
      .favorites {
        border: 2px solid #333;
        border-radius: 4px;
        background-color: #fff;
        height: 300px;
        display: flex;
        flex-direction: column;
        padding: 0;
        /* Ensure no extra padding */
        margin: 0;
        /* Ensure no margin interference */
      }

      .results-container {
        flex-grow: 1;
        overflow-y: auto;
      }

      .song-list {
        list-style: none;
        overflow-y: auto;
      }

      .song-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #ddd;
      }

      .song-item:hover {
        background-color: #f0f0f0;
      }

      .section-title {
        text-align: center;
        font-weight: bold;
        background-color: #ddd;
        /* Background color */
        padding: 10px;
        /* Padding for spacing */
        border-bottom: 2px solid black;
        /* Bottom border */
        width: 100%;
        /* Ensure it spans full width */
        box-sizing: border-box;
        /* Ensures padding doesn't affect width */
      }

      .playing {
        /* Removed background color for playing songs */
        font-weight: bold;
      }

      #auth-status {
        grid-column: 2 / 3;
        grid-row: 1 / 2;
        text-align: right;
        font-size: 14px;
        padding: 5px;
      }

      .error {
        color: red;
      }

      #spotify-player {
        display: none;
        width: 100%;
        height: 80px;
        border: none;
        margin-top: 10px;
      }

      .login-button {
        background-color: #333;
        color: #f0f0f0;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        cursor: pointer;
        font-size: 14px;
      }

      #next-button {
        background-color: #333;
        color: #f0f0f0;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
        align-self: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search or paste Spotify link">
        <button id="search-button">üîç</button>
      </div>
      <div id="auth-status">
        <button id="login-button" class="login-button">Login to Spotify</button>
      </div>
      <div class="music-player">
        <div class="song-info">
          <div class="song-title">Song player</div>
          <div class="song-artist">Select a song to play</div>
        </div>
        <iframe id="spotify-player" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
      </div>
      <div class="search-results">
        <div class="section-title">Results</div>
        <div class="results-container">
          <ul class="song-list" id="search-results-list">
            <!-- Search results will appear here -->
          </ul>
        </div>
      </div>

      <div class="favorites">
        <div class="section-title">Favorites</div>
        <div class="results-container">
          <ul class="song-list" id="favorites-list">
            <!-- Favorites will appear here -->
          </ul>
        </div>
      </div>
    </div>

    <script>
      // Spotify API Configuration
      const clientId = 'cc1434a8593d4c71b9ad56af9b578d98';
      const redirectUri = 'https://bootlifexu.github.io/Spofi'; // Same redirect URI
      let accessToken = null;

      const searchInput = document.getElementById('search-input');
      const searchButton = document.getElementById('search-button');
      const searchResultsList = document.getElementById('search-results-list');
      const spotifyPlayer = document.getElementById('spotify-player');
      const authStatus = document.getElementById('auth-status');
      const loginButton = document.getElementById('login-button');
      const favoritesList = document.getElementById('favorites-list');

      // Favorite songs array
      let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

      // Check for Spotify token
      function checkForSpotifyToken() {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const token = params.get('access_token');
        if (token) {
          accessToken = token;
          localStorage.setItem('spotify_access_token', token);
          window.history.replaceState(null, null, window.location.pathname); // Remove hash from URL
          updateAuthStatus('Logged in to Spotify');
          loginButton.style.display = 'none';
          return true;
        }
        const storedToken = localStorage.getItem('spotify_access_token');
        if (storedToken) {
          accessToken = storedToken;
          updateAuthStatus('Logged in to Spotify');
          loginButton.style.display = 'none';
          return true;
        }
        return false;
      }

      function updateAuthStatus(message, isError = false) {
        if (isError) {
          authStatus.innerHTML = `<span class="error">${message}</span>`;
        } else {
          authStatus.innerHTML = message;
        }
      }

      function initiateSpotifyAuth() {
        const scopes = ['user-library-read', 'user-read-playback-state', 'user-modify-playback-state', 'streaming'];
        const authUrl = `https://accounts.spotify.com/authorize?` +
                        `client_id=${clientId}` +
                        `&response_type=token` +
                        `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                        `&scope=${encodeURIComponent(scopes.join(' '))}`;
        window.location.href = authUrl;
      }

      // Check if URL is a Spotify track, playlist, or artist
      function isSpotifyUrl(url) {
        const trackRegex = /https:\/\/open.spotify.com\/track\/([a-zA-Z0-9]{22})/;
        const playlistRegex = /https:\/\/open.spotify.com\/playlist\/([a-zA-Z0-9]{22})/;
        const artistRegex = /https:\/\/open.spotify.com\/artist\/([a-zA-Z0-9]{22})/;

        if (trackRegex.test(url)) {
          return { type: 'track', id: url.match(trackRegex)[1] };
        }
        if (playlistRegex.test(url)) {
          return { type: 'playlist', id: url.match(playlistRegex)[1] };
        }
        if (artistRegex.test(url)) {
          return { type: 'artist', id: url.match(artistRegex)[1] };
        }
        return null;
      }

      // Handle URL Search or General Search
      async function performSearch(query) {
        const urlInfo = isSpotifyUrl(query);
        if (urlInfo) {
          if (urlInfo.type === 'track') {
            playTrack(urlInfo.id);
          } else if (urlInfo.type === 'playlist') {
            fetchPlaylist(urlInfo.id);
          } else if (urlInfo.type === 'artist') {
            fetchArtist(urlInfo.id);
          }
          return;
        }

        try {
          const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track,playlist,artist&limit=10`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
          });
          const data = await response.json();
          displaySearchResults(data.tracks.items, 'Tracks');
          displaySearchResults(data.playlists.items, 'Playlists');
          displaySearchResults(data.artists.items, 'Artists');
        } catch (error) {
          updateAuthStatus('Search error: ' + error.message, true);
        }
      }

      // Display Search Results
      function displaySearchResults(items, type) {
        if (!items || items.length === 0) return;

        const section = document.createElement('div');
        section.className = 'section-title';
        section.innerText = `${type}:`;

        const list = document.createElement('ul');
        items.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item.name;
          li.addEventListener('click', () => handleSelection(item, type));
          list.appendChild(li);
        });

        searchResultsList.appendChild(section);
        searchResultsList.appendChild(list);
      }

      // Handle Track, Playlist, Artist Selection
      function handleSelection(item, type) {
        if (type === 'Tracks') {
          playTrack(item.id);
        } else if (type === 'Playlists') {
          fetchPlaylist(item.id);
        } else if (type === 'Artists') {
          fetchArtist(item.id);
        }
      }

      // Play Track
      function playTrack(trackId) {
        spotifyPlayer.src = `https://open.spotify.com/embed/track/${trackId}`;
        spotifyPlayer.style.display = 'block';
      }

      // Fetch Playlist (Display tracks)
      async function fetchPlaylist(playlistId) {
        const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await response.json();
        alert(`Playlist: ${data.name} contains ${data.items.length} tracks.`);
      }

      // Fetch Artist (Display top tracks or albums)
      async function fetchArtist(artistId) {
        const response = await fetch(`https://api.spotify.com/v1/artists/${artistId}/top-tracks?market=US`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await response.json();
        alert(`Top tracks of artist: ${data.tracks.length}`);
      }

      // Handle Search Button Click
      searchButton.addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (query) {
          performSearch(query);
        }
      });

      // Login Button
      loginButton.addEventListener('click', () => {
        initiateSpotifyAuth();
      });

      // Initialize
      window.addEventListener('load', () => {
        checkForSpotifyToken();
      });

      // Add to Favorites
      function addToFavorites(track) {
        if (!favorites.some(fav => fav.id === track.id)) {
          favorites.push(track);
          localStorage.setItem('favorites', JSON.stringify(favorites));
          displayFavorites();
        }
      }

      // Display Favorites
      function displayFavorites() {
        favoritesList.innerHTML = '';
        favorites.forEach(track => {
          const li = document.createElement('li');
          li.textContent = track.name;
          li.className = 'song-item';
          li.addEventListener('click', () => playTrack(track.id));
          favoritesList.appendChild(li);
        });
      }

      // Display Favorites on Load
      displayFavorites();

    </script>
  </body>
</html>
